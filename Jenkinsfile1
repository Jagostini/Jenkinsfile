node {
    def mvnHome = tool name: 'M3', type: 'maven'
    def mvnCMD
    //def javaHome = env.JAVA_HOME="${tool 'Jdk'}"
    //def javaHome = tool name: 'Jdk'
    def scannerHome
    
    stage('Preparation') {
        if (isUnix()) {
            mvnCMD = "${mvnHome}/bin/mvn"
            sh "${mvnCMD} --version"
	    } else {
	   	    mvnCMD = "${mvnHome}\\bin\\mvn"
	   	    bat (/"${mvnCMD}" --version/)
	    }
    }
	
    stage('Slack Notification'){
        slackSend "Build Started - ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open>)" 
    }
    
    stage('SCM Checkout') {
        echo 'Pulling changes'
        git url: 'https://github.com/Jagostini/tp-hibernate.git/'
    }
    
    stage('SonarQube analysis') { 
        scannerHome = tool 'SonarQube Scanner 2.8'
		withSonarQubeEnv('TPORM') {
		    mvnCMD = "${mvnHome}\\bin\\mvn"
		    bat (/"${mvnCMD}" sonar:sonar/)
		}
    }
    
	stage('Build') {
		// Run the maven build
		env.JAVA_HOME="${tool 'Jdk'}"
		mvnCMD = "${mvnHome}\\bin\\mvn"
		bat(/"${mvnCMD}" -Dmaven.test.failure.ignore clean package/)
	}
    
	stage('Results') {
		junit '**/target/surefire-reports/TEST-*.xml'
		archive 'target/*.jar'
	}
		
	stage ('Distribute binaries to Artifactory') { 
		def SERVER_ID = 'art-1' 
		def server = Artifactory.server SERVER_ID
		def uploadSpec = 
		"""
		{
			"files": [
			{
				"pattern": "all/target/all-(*).war",
				"target": "libs-snapshots-local/com/huettermann/web/{1}/"
			}]
		}
		"""
		def buildInfo = Artifactory.newBuildInfo() 
		buildInfo.env.capture = true 
		buildInfo=server.upload(uploadSpec) 
		server.publishBuildInfo(buildInfo) 
	}
}
